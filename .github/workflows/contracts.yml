name: Contract Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  contract-compile:
    name: Compile TypeScript Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile contracts
        run: pnpm test:contracts:compile
        
      - name: Check for 'any' types
        run: |
          echo "Checking for TypeScript 'any' types in contracts..."
          if grep -r ":\s*any" contracts/; then
            echo "❌ Found 'any' types in contracts (violates strict mode)"
            exit 1
          else
            echo "✅ No 'any' types found"
          fi

  contract-validate:
    name: Validate Golden JSON Fixtures
    runs-on: ubuntu-latest
    needs: contract-compile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate golden fixtures
        run: pnpm test:contracts:validate

  contract-hashes:
    name: Execute Golden Paths & Validate Hashes
    runs-on: ubuntu-latest
    needs: contract-validate
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dvt_test
          POSTGRES_PASSWORD: dvt_test
          POSTGRES_DB: dvt_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test

      - name: Execute golden paths
        run: pnpm test:contracts:hashes
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test
        timeout-minutes: 5

      - name: Compare snapshot hashes
        run: |
          echo "Comparing snapshot hashes..."
          pnpm test:contracts:hash-compare
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contract-test-results
          path: |
            test/contracts/results/
            .golden/hashes.json

  check-critical-path:
    name: Validate Critical Path Order
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract issue number from branch name (e.g., feat/8-glossary)
          if [[ $BRANCH_NAME =~ ^[^/]+/([0-9]+)- ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            echo "Issue number: $ISSUE_NUM"
            echo "ISSUE_NUM=$ISSUE_NUM" >> $GITHUB_ENV
          else
            echo "⚠️ Branch name doesn't follow pattern: type/number-description"
            echo "ISSUE_NUM=" >> $GITHUB_ENV
          fi

      - name: Validate critical path
        if: env.ISSUE_NUM != ''
        run: |
          # Critical path order: 8 → 9 → 2 → 5,6 → 10
          CRITICAL_PATH=(8 9 2 5 6 10 14 15 16 17)
          ISSUE=${{ env.ISSUE_NUM }}
          
          echo "Checking if issue #$ISSUE follows critical path..."
          
          # Check if this is a critical path issue
          if [[ " ${CRITICAL_PATH[@]} " =~ " ${ISSUE} " ]]; then
            echo "✅ Issue #$ISSUE is in critical path"
            
            # TODO: Check if prerequisite issues are closed
            # This requires GitHub CLI or API access
            echo "⚠️ Manual review required: Verify prerequisite issues are closed"
          else
            echo "ℹ️ Issue #$ISSUE is not in critical path (can run parallel)"
          fi
