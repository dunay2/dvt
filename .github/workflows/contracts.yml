name: Contracts & Determinism

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-json-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate JSON schemas
        run: |
          set -e
          pnpm install -g ajv@8 ajv-cli
          shopt -s nullglob
          files=(docs/architecture/engine/contracts/**/*.schema.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No schema files found â€” skipping"
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Validating $f"
            npx ajv compile -s "$f"
          done

  determinism-checks:
    name: Determinism Pattern Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run determinism linting
        run: pnpm lint:determinism

      - name: Check for Date.now()
        run: |
          echo "ðŸ” Scanning for Date.now() in engine workflows..."
          if grep -r "Date\.now()" engine/ \
            --exclude-dir=test \
            --exclude-dir=node_modules \
            --exclude=OutboxWorker.ts; then
            echo "âŒ Found Date.now() calls (use workflow.now() in Temporal workflows)"
            exit 1
          else
            echo "âœ… No Date.now() calls found"
          fi

      - name: Check for Math.random()
        run: |
          echo "ðŸ” Scanning for Math.random() in engine workflows..."
          if grep -r "Math\.random()" engine/ \
            --exclude-dir=test \
            --exclude-dir=node_modules \
            --exclude=OutboxWorker.ts; then
            echo "âŒ Found Math.random() calls (use workflow-seeded RNG)"
            exit 1
          else
            echo "âœ… No Math.random() calls found"
          fi

      - name: Check for crypto.randomBytes()
        run: |
          echo "ðŸ” Scanning for crypto.randomBytes() in engine workflows..."
          if grep -r "crypto\.randomBytes" engine/ \
            --exclude-dir=test \
            --exclude-dir=node_modules \
            --exclude=OutboxWorker.ts; then
            echo "âŒ Found crypto.randomBytes() calls (use deterministic UUID generation)"
            exit 1
          else
            echo "âœ… No crypto.randomBytes() calls found"
          fi

  contract-compile:
    name: Compile TypeScript Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile contracts
        run: pnpm test:contracts:compile

      - name: Check for 'any' types
        run: |
          echo "Checking for TypeScript 'any' types in contracts..."
          if [ -d "contracts" ]; then
            if grep -r ":\s*any" contracts/ 2>/dev/null; then
              echo "âŒ Found 'any' types in contracts (violates strict mode)"
              exit 1
            else
              echo "âœ… No 'any' types found"
            fi
          else
            echo "âš ï¸  contracts/ directory not yet created (awaiting issue #2)"
            echo "âœ… Check passed (stub mode)"
          fi

  contract-validate:
    name: Validate Golden JSON Fixtures
    runs-on: ubuntu-latest
    needs: contract-compile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate golden fixtures
        run: pnpm test:contracts:validate
        continue-on-error: true

  contract-hashes:
    name: Execute Golden Paths & Validate Hashes
    runs-on: ubuntu-latest
    needs: contract-validate
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dvt_test
          POSTGRES_PASSWORD: dvt_test
          POSTGRES_DB: dvt_test
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test

      - name: Execute golden paths
        run: pnpm test:contracts:hashes
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test
        timeout-minutes: 5

      - name: Compare snapshot hashes
        run: |
          echo "Comparing snapshot hashes..."
          pnpm test:contracts:hash-compare
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: contract-test-results
          path: |
            test/contracts/results/
            .golden/hashes.json
