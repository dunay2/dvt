name: Contracts & Determinism

# Blocking policy (issue #93):
# - Critical contract checks MUST fail the job and block merge.
# - Documented exceptions:
#   1) Scope gating: jobs are skipped when no relevant files changed on PRs.
#   2) JSON schema validation is skipped only when no *.schema.json files exist.

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: contracts-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect contracts/determinism scope
    runs-on: ubuntu-latest
    outputs:
      contracts_relevant: ${{ steps.changes.outputs.contracts_relevant }}
      determinism_relevant: ${{ steps.changes.outputs.determinism_relevant }}
      golden_relevant: ${{ steps.changes.outputs.golden_relevant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changed areas (PR only)
        id: changes
        if: github.event_name == 'pull_request'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            contracts_relevant:
              - 'packages/contracts/**'
              - 'packages/engine/test/contracts/**'
              - 'docs/architecture/engine/contracts/**'
              - '.golden/**'
              - 'scripts/compare-hashes.cjs'
              - 'scripts/db-migrate.cjs'
              - 'scripts/validate-contracts.cjs'
              - '.github/workflows/contracts.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
            determinism_relevant:
              - 'packages/engine/**'
              - 'packages/contracts/**'
              - '.github/workflows/contracts.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
            golden_relevant:
              - 'packages/engine/test/contracts/**'
              - 'docs/architecture/engine/contracts/**'
              - '.golden/**'
              - 'scripts/compare-hashes.cjs'
              - 'scripts/db-migrate.cjs'
              - '.github/workflows/contracts.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'

      - name: Set default outputs (non-PR events)
        if: github.event_name != 'pull_request'
        run: |
          echo "contracts_relevant=true" >> "$GITHUB_OUTPUT"
          echo "determinism_relevant=true" >> "$GITHUB_OUTPUT"
          echo "golden_relevant=true" >> "$GITHUB_OUTPUT"
        shell: bash

  validate-json-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if:
      github.event_name != 'pull_request' || needs.detect-changes.outputs.contracts_relevant ==
      'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate JSON schemas
        run: |
          set -euo pipefail
          echo "Checking for JSON schema files..."
          if ! find docs/architecture/engine/contracts -name "*.schema.json" -type f 2>/dev/null | grep -q .; then
            echo "No schema files found â€” skipping"
            exit 0
          fi

          echo "Validating draft 2020-12 schemas..."
          mapfile -t draft2020_schemas < <(grep -RIl --include="*.schema.json" '"\$schema"[[:space:]]*:[[:space:]]*"https://json-schema.org/draft/2020-12/schema"' docs/architecture/engine/contracts || true)
          if [ ${#draft2020_schemas[@]} -gt 0 ]; then
            for schema in "${draft2020_schemas[@]}"; do
              npx --yes ajv-cli@5 compile --spec=draft2020 --strict=false -s "$schema"
            done
          else
            echo "No draft 2020-12 schemas found"
          fi

          echo "Validating draft-07/legacy schemas..."
          mapfile -t draft7_schemas < <(find docs/architecture/engine/contracts -name "*.schema.json" -type f 2>/dev/null | while read -r f; do
            if ! grep -q '"\$schema"[[:space:]]*:[[:space:]]*"https://json-schema.org/draft/2020-12/schema"' "$f"; then
              echo "$f"
            fi
          done)
          if [ ${#draft7_schemas[@]} -gt 0 ]; then
            for schema in "${draft7_schemas[@]}"; do
              npx --yes ajv-cli@5 compile --spec=draft7 --strict=false -s "$schema"
            done
          else
            echo "No draft-07/legacy schemas found"
          fi

          echo "âœ… Schema validation complete"

  determinism-checks:
    name: Determinism Pattern Scan
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if:
      github.event_name != 'pull_request' || needs.detect-changes.outputs.determinism_relevant ==
      'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run determinism linting
        run: pnpm lint:determinism

      - name: Check for Date.now()
        run: |
          echo "ðŸ” Scanning for Date.now() in engine workflows..."
          if grep -r "Date\.now()" packages/engine/src --exclude-dir=node_modules 2>/dev/null | grep -v "OutboxWorker.ts" | grep -q .; then
            echo "âŒ Found Date.now() calls (use workflow.now() in Temporal workflows)"
            exit 1
          else
            echo "âœ… No Date.now() calls found"
          fi

      - name: Check for Math.random()
        run: |
          echo "ðŸ” Scanning for Math.random() in engine workflows..."
          if grep -r "Math\.random()" packages/engine/src --exclude-dir=node_modules 2>/dev/null | grep -v "OutboxWorker.ts" | grep -q .; then
            echo "âŒ Found Math.random() calls (use workflow-seeded RNG)"
            exit 1
          else
            echo "âœ… No Math.random() calls found"
          fi

      - name: Check for crypto.randomBytes()
        run: |
          echo "ðŸ” Scanning for crypto.randomBytes() in engine workflows..."
          if grep -r "crypto\.randomBytes" packages/engine/src --exclude-dir=node_modules 2>/dev/null | grep -v "OutboxWorker.ts" | grep -q .; then
            echo "âŒ Found crypto.randomBytes() calls (use deterministic UUID generation)"
            exit 1
          else
            echo "âœ… No crypto.randomBytes() calls found"
          fi

  contract-compile:
    name: Compile TypeScript Contracts
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if:
      github.event_name != 'pull_request' || needs.detect-changes.outputs.contracts_relevant ==
      'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compile contracts
        run: pnpm test:contracts:compile

      - name: Check for 'any' types
        run: |
          echo "Checking for TypeScript 'any' types in contracts..."
          if [ -d "packages/contracts/src" ]; then
            if grep -rE ":\s*any" packages/contracts/src 2>/dev/null | grep -q .; then
              echo "âŒ Found 'any' types in contracts (violates strict mode)"
              exit 1
            else
              echo "âœ… No 'any' types found"
            fi
          else
            echo "âš ï¸  packages/contracts/src directory not found"
            echo "âœ… Check passed (stub mode)"
          fi

      - name: Upload compiled contracts artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: compiled-contracts
          path: |
            packages/contracts/dist/
            packages/contracts/src/**/*.js
            packages/contracts/src/**/*.d.ts

  contract-validate:
    name: Validate Golden JSON Fixtures
    runs-on: ubuntu-latest
    needs: [detect-changes, contract-compile]
    if:
      github.event_name != 'pull_request' || needs.detect-changes.outputs.contracts_relevant ==
      'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download compiled contracts artifact
        uses: actions/download-artifact@v6
        with:
          name: compiled-contracts
          path: .

      - name: Validate golden fixtures
        run: pnpm validate:contracts

  contract-hashes:
    name: Execute Golden Paths & Validate Hashes
    runs-on: ubuntu-latest
    needs: [detect-changes, contract-validate]
    if:
      github.event_name != 'pull_request' || needs.detect-changes.outputs.golden_relevant == 'true'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dvt_test
          POSTGRES_PASSWORD: dvt_test
          POSTGRES_DB: dvt_test
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download compiled contracts artifact
        uses: actions/download-artifact@v6
        with:
          name: compiled-contracts
          path: .

      - name: Run database migrations
        run: node scripts/db-migrate.cjs
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test

      - name: Execute golden paths
        run: pnpm golden:validate
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test
        timeout-minutes: 5

      - name: Compare snapshot hashes (blocking)
        run: |
          set -euo pipefail
          echo "Comparing snapshot hashes..."
          node scripts/compare-hashes.cjs

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: contract-test-results
          path: |
            packages/engine/test/contracts/results/
            .golden/hashes.json
