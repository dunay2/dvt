name: Validate Markdown Documentation

on:
  pull_request:
    paths:
      - '**.md'
      - 'docs/**/*.md'
      - '.github/workflows/markdown_lint.yml'
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'docs/**/*.md'

jobs:
  markdown-lint:
    name: Lint Markdown Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install markdownlint-cli2
        run: npm install -g markdownlint-cli2
      
      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "line-length": false,
            "no-inline-html": false,
            "first-line-heading": false
          }
          EOF
      
      - name: Lint Markdown files
        run: |
          markdownlint-cli2 "**/*.md" "#node_modules" "#.git"

  # TEMPORARILY DISABLED: TypeScript validation too strict for pseudocode/examples
  # TODO: Re-enable after adding @ts-nocheck to example blocks or making validation more permissive
  # validate-typescript-blocks:
  #   name: Validate TypeScript Code Blocks
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     
  #     - name: Install TypeScript
  #       run: npm install -g typescript
  #     
  #     - name: Extract and validate TypeScript blocks
  #       run: |
  #         set -e
  #         
  #         # Find all .md files with TypeScript code blocks
  #         MD_FILES=$(find docs -name "*.md" -type f)
  #         
  #         if [ -z "$MD_FILES" ]; then
  #           echo "No markdown files found in docs/"
  #           exit 0
  #         fi
  #         
  #         BLOCK_COUNT=0
  #         ERROR_COUNT=0
  #         
  #         for md_file in $MD_FILES; do
  #           echo "Processing: $md_file"
  #           
  #           # Extract TypeScript blocks (```ts or ```typescript)
  #           # This sed command extracts content between ```ts/```typescript and ```
  #           sed -n '/```\(ts\|typescript\)/,/```/p' "$md_file" | \
  #             sed '1d;$d' > "/tmp/extracted_${BLOCK_COUNT}.ts" 2>/dev/null || true
  #           
  #           if [ -s "/tmp/extracted_${BLOCK_COUNT}.ts" ]; then
  #             echo "  Found TypeScript block #${BLOCK_COUNT}"
  #             
  #             # Validate with tsc (allow TS features, no lib/dom checks)
  #             if ! tsc --noEmit --skipLibCheck --allowJs \
  #                  --target ES2020 --module commonjs \
  #                  "/tmp/extracted_${BLOCK_COUNT}.ts" 2>&1; then
  #               echo "  ❌ TypeScript validation failed in $md_file (block #${BLOCK_COUNT})"
  #               ERROR_COUNT=$((ERROR_COUNT + 1))
  #             else
  #               echo "  ✅ TypeScript block valid"
  #             fi
  #             
  #             BLOCK_COUNT=$((BLOCK_COUNT + 1))
  #           fi
  #         done
  #         
  #         echo ""
  #         echo "Summary: Validated $BLOCK_COUNT TypeScript blocks"
  #         
  #         if [ $ERROR_COUNT -gt 0 ]; then
  #           echo "❌ $ERROR_COUNT blocks failed validation"
  #           exit 1
  #         else
  #           echo "✅ All TypeScript blocks are syntactically valid"
  #         fi

  validate-internal-links:
    name: Validate Internal Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check
      
      - name: Check internal links
        run: |
          set -e
          
          # Config to only check relative links (skip external URLs to avoid rate limits)
          cat > /tmp/mlc_config.json << 'EOF'
          {
            "ignorePatterns": [
              {
                "pattern": "^https?://"
              }
            ],
            "timeout": "5s",
            "retryOn429": false
          }
          EOF
          
          # Find all markdown files
          MD_FILES=$(find docs -name "*.md" -type f)
          
          if [ -z "$MD_FILES" ]; then
            echo "No markdown files found"
            exit 0
          fi
          
          ERROR_COUNT=0
          
          for file in $MD_FILES; do
            echo "Checking links in: $file"
            if ! markdown-link-check --config /tmp/mlc_config.json "$file"; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo ""
            echo "❌ Found broken links in $ERROR_COUNT file(s)"
            exit 1
          else
            echo ""
            echo "✅ All internal links are valid"
          fi

  validate-normative-contracts:
    name: Validate Normative Contract Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check normative contract requirements
        run: |
          set -e
          
          echo "Validating normative contracts in docs/architecture/engine/contracts/"
          
          # Find all .md files with version numbers (e.g., ExecutionSemantics.v1.md)
          CONTRACTS=$(find docs/architecture/engine/contracts -name "*.v[0-9]*.md" -type f 2>/dev/null || true)
          
          if [ -z "$CONTRACTS" ]; then
            echo "No versioned contracts found — skipping"
            exit 0
          fi
          
          ERROR_COUNT=0
          
          for contract in $CONTRACTS; do
            echo ""
            echo "Checking: $contract"
            
            # Check for required headers (using -F for fixed string match to avoid regex issues with **)
            if ! grep -qF "**Status**:" "$contract"; then
              echo "  ❌ Missing **Status** field"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            
            if ! grep -qF "**Version**:" "$contract"; then
              echo "  ❌ Missing **Version** field"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            
            if ! grep -q "^## Change Log" "$contract"; then
              echo "  ❌ Missing ## Change Log section"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            
            # Check for VERSIONING.md reference
            if ! grep -q "VERSIONING.md" "$contract"; then
              echo "  ⚠️  Warning: No reference to VERSIONING.md found"
            fi
            
            # Check for MUST/MUST NOT (normative language)
            if grep -q "MUST\|MUST NOT" "$contract"; then
              echo "  ✅ Uses normative language (MUST/MUST NOT)"
            else
              echo "  ⚠️  Warning: No normative language found (may not be normative)"
            fi
            
            if [ $ERROR_COUNT -eq 0 ]; then
              echo "  ✅ Contract structure valid"
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo ""
            echo "❌ Found $ERROR_COUNT validation error(s)"
            exit 1
          else
            echo ""
            echo "✅ All normative contracts have required structure"
          fi
