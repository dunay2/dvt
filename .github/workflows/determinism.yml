name: Determinism Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  determinism-lint:
    name: Determinism Linting Rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run determinism linting
        run: pnpm lint:determinism

  forbidden-patterns:
    name: Scan for Non-Deterministic Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Date.now()
        run: |
          echo "üîç Scanning for Date.now() in engine code..."
          if grep -r "Date\.now()" engine/ --exclude-dir=test --exclude-dir=node_modules; then
            echo "‚ùå Found Date.now() calls (use workflow.now() in Temporal workflows)"
            exit 1
          else
            echo "‚úÖ No Date.now() calls found"
          fi

      - name: Check for Math.random()
        run: |
          echo "üîç Scanning for Math.random() in engine code..."
          if grep -r "Math\.random()" engine/ --exclude-dir=test --exclude-dir=node_modules; then
            echo "‚ùå Found Math.random() calls (use workflow-seeded RNG)"
            exit 1
          else
            echo "‚úÖ No Math.random() calls found"
          fi

      - name: Check for crypto.randomBytes()
        run: |
          echo "üîç Scanning for crypto.randomBytes() in engine code..."
          if grep -r "crypto\.randomBytes" engine/ --exclude-dir=test --exclude-dir=node_modules; then
            echo "‚ùå Found crypto.randomBytes() calls (use deterministic UUID generation)"
            exit 1
          else
            echo "‚úÖ No crypto.randomBytes() calls found"
          fi

      - name: Check for process.env in engine
        run: |
          echo "üîç Scanning for process.env in engine core..."
          if grep -r "process\.env" engine/core/ --exclude-dir=test --exclude-dir=node_modules; then
            echo "‚ùå Found process.env access in engine core (inject config via constructor)"
            exit 1
          else
            echo "‚úÖ No process.env access in engine core"
          fi

  idempotency-test:
    name: Idempotency Hash Validation
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dvt_test
          POSTGRES_PASSWORD: dvt_test
          POSTGRES_DB: dvt_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test

      - name: Test idempotency (replay events)
        run: pnpm test:idempotency
        env:
          DATABASE_URL: postgresql://dvt_test:dvt_test@localhost:5432/dvt_test
        timeout-minutes: 10

      - name: Validate hash stability
        run: |
          echo "üîç Validating that replay produces identical hashes..."
          pnpm test:idempotency:validate-hashes
          
      - name: Upload idempotency test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: idempotency-test-results
          path: test/idempotency/results/
